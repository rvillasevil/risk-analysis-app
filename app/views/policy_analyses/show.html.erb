<div class="container py-4 dashboard-view">
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Comparativa de pólizas (Análisis #<%= @policy_analysis.id %>)</h1>
      <p class="text-muted mb-0">Compara parámetros clave y descarga el resumen para compartirlo con tu equipo.</p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <span class="badge <%= @policy_analysis.extractions.present? ? 'bg-status-ready' : 'bg-status-pending' %>">
        <%= @policy_analysis.extractions.present? ? 'Listo' : 'Procesando' %>
      </span>
      <%= link_to "Volver", policy_analyses_path, class: "btn btn-outline-secondary" %>
      <% if @policy_analysis.extractions.present? %>
        <%= link_to "Descargar JSON", policy_analysis_path(@policy_analysis, format: :json), class: "btn btn-outline-primary", data: { turbo: false } %>
      <% end %>
    </div>
  </div>

  <% unless @policy_analysis.extractions.present? %>
    <div class="text-center py-5">
      <span class="spinner-border" role="status"></span>
      <p class="mt-3">Analizando… por favor espera.</p>
    </div>
  <% else %>
    <% docs = JSON.parse(@policy_analysis.extractions) %>
    <% all_params = docs.flat_map { |d| d["parametros"].map { |p| p["parametro"] } }.uniq %>

    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card shadow-sm h-100" data-state="ready">
          <div class="card-body">
            <p class="text-muted text-uppercase small mb-1">Documentos analizados</p>
            <h2 class="h4 mb-0"><%= docs.size %></h2>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm h-100" data-state="pending">
          <div class="card-body">
            <p class="text-muted text-uppercase small mb-1">Parámetros comparados</p>
            <h2 class="h4 mb-0"><%= all_params.size %></h2>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm h-100" data-state="alert">
          <div class="card-body">
            <p class="text-muted text-uppercase small mb-1">Diferencias detectadas</p>
            <h2 class="h4 mb-0"><%= all_params.count do |param_name|
              valores = docs.map do |d|
                p = d["parametros"].find { |pr| pr["parametro"] == param_name }
                p ? p["contenido"].strip : ""
              end
              valores.uniq.reject(&:blank?).size > 1
            end %></h2>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-white">
        <h2 class="h5 mb-0">Comparativa detallada</h2>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered align-top">
            <thead class="table-light text-center">
              <tr>
                <th>Parámetro</th>
                <% docs.each do |d| %>
                  <th><%= d["filename"] %></th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% all_params.each do |param_name| %>
                <% valores = docs.map do |d|
                    p = d["parametros"].find { |pr| pr["parametro"] == param_name }
                    p ? p["contenido"].strip : ""
                  end %>
                <% diff = valores.uniq.reject(&:blank?).size > 1 %>
                <tr class="<%= diff ? 'table-warning' : '' %>">
                  <th class="align-top"><%= param_name %></th>
                  <% docs.each do |d| %>
                    <% p = d["parametros"].find { |pr| pr["parametro"] == param_name } %>
                    <td class="whitespace-pre-wrap">
                      <% if p %>
                        <small class="text-muted">
                          <% if p["paginas"].present? %>
                            [pág. <%= p["paginas"].join(",") %>]
                          <% end %>
                        </small>
                        <div><%= simple_format(p["contenido"]) %></div>
                      <% else %>
                        <em>—</em>
                      <% end %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <% if @policy_analysis.rating.present? %>
      <div class="card shadow-sm border-0 mb-4" data-state="ready">
        <div class="card-header bg-white">
          <strong>Ranking de pólizas (mejor cobertura + menor prima)</strong>
        </div>
        <div class="card-body">
          <pre class="mb-0" style="white-space: pre-wrap;"><%= @policy_analysis.rating %></pre>
        </div>
      </div>
    <% end %>
  <% end %>

  <div class="card shadow-sm border-0">
    <div class="card-header bg-white">
      <h2 class="h5 mb-0">Preguntar sobre estas pólizas</h2>
    </div>
    <div class="card-body">
      <%= form_with url: ask_policy_analysis_path(@policy_analysis), method: :post, local: true do |f| %>
        <div class="mb-3">
          <%= f.label :question, "Tu pregunta", class: 'form-label' %>
          <%= f.text_area :question, class: "form-control", rows: 2, required: true %>
        </div>
        <%= f.submit "Enviar pregunta", class: "btn btn-primary" %>
      <% end %>
      <% if flash[:policy_answer].present? %>
        <div class="alert alert-info mt-4">
          <strong>Respuesta:</strong>
          <p class="mb-0"><%= flash[:policy_answer] %></p>
        </div>
      <% end %>
    </div>
  </div>
</div>












