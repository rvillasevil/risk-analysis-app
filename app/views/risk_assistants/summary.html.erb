<%# app/views/risk_assistants/summary.html.erb %>
<div class="container py-4">
  <h1 class="mb-4"><%= @risk_assistant.name %> – Resumen de datos recopilados</h1>

  <% RiskFieldSet.all.each do |section_id, section_hash| %>
    <% section_label = section_hash[:title] %>
    <% fields = section_hash[:fields] %>

    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><%= section_label %></h5>
      </div>
      <div class="card-body p-3">
        <table class="table table-striped table-borderless mb-0">
          <tbody>
            <% fields.each do |f| %>
              <% key    = f[:id].to_s %>
              <% label  = f[:label] %>
              <% value  = @risk_assistant.messages.where(key: key).order(:created_at).pluck(:value).first %>
              <% next if value.blank? && f[:type].to_s != "array_of_objects" %>

              <tr>
                <th class="w-50 align-middle"><%= label %></th>
                <td>
                  <% case f[:type].to_s %>
                  <% when "boolean" %>
                    <% if %w[true Sí sí SÍ].include?(value) %>
                      <span class="badge bg-success">Sí</span>
                    <% else %>
                      <span class="badge bg-danger">No</span>
                    <% end %>

                  <% when "select" %>
                    <span class="badge bg-info text-dark"><%= value %></span>

                  <% when "number" %>
                    <%= number_with_delimiter(value.to_f, delimiter: ".") %>

                  <% when "array_of_objects" %>
                    <% array_parent = f[:id] %>
                    <% subfields = RiskFieldSet.flat_fields.select { |sf| sf[:parent] == array_parent } %>
                    <% rows = @risk_assistant.messages
                              .where("key LIKE ?", "#{array_parent}.%")
                              .order(:created_at) %>
                    <% grouped = {} %>
                    <% rows.each do |msg| %>
                      <% parts = msg.key.split(".", 3) %>
                      <% idx  = parts[1] %>
                      <% col  = parts[2] %>
                      <% grouped[idx] ||= {} %>
                      <% grouped[idx][col] = msg.value %>
                    <% end %>

                    <table class="table table-sm table-bordered mt-2 mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>#</th>
                          <% subfields.each do |sf| %>
                            <th><%= sf[:label] %></th>
                          <% end %>
                        </tr>
                      </thead>
                      <tbody>
                        <% grouped.each_with_index do |(_idx, values), row_i| %>
                          <tr>
                            <td><%= row_i + 1 %></td>
                            <% subfields.each do |sf| %>
                              <% col_id = sf[:id].split(".").last %>
                              <% cell = values[col_id] %>
                              <% if sf[:type].to_s == "array_of_objects" %>
                                <% nested_parent = sf[:id] %>
                                <% nested_subfields = RiskFieldSet.flat_fields.select { |nsf| nsf[:parent] == nested_parent } %>
                                <% nested_rows = @risk_assistant.messages
                                                  .where("key LIKE ?", "#{nested_parent}.%")
                                                  .order(:created_at) %>
                                <% nested_grouped = {} %>
                                <% nested_rows.each do |nmsg| %>
                                  <% nparts = nmsg.key.split(".", 3) %>
                                  <% nidx  = nparts[1] %>
                                  <% ncol  = nparts[2] %>
                                  <% nested_grouped[nidx] ||= {} %>
                                  <% nested_grouped[nidx][ncol] = nmsg.value %>
                                <% end %>

                                <table class="table table-sm table-bordered mb-0">
                                  <thead class="table-secondary">
                                    <tr>
                                      <th>#</th>
                                      <% nested_subfields.each do |nsf| %>
                                        <th><%= nsf[:label] %></th>
                                      <% end %>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <% nested_grouped.each_with_index do |(_nidx, nvalues), ni| %>
                                      <tr>
                                        <td><%= ni + 1 %></td>
                                        <% nested_subfields.each do |nsf| %>
                                          <% ncol_id = nsf[:id].split(".").last %>
                                          <td><%= nvalues[ncol_id] %></td>
                                        <% end %>
                                      </tr>
                                    <% end %>
                                  </tbody>
                                </table>
                              <% else %>
                                <%= simple_format(cell.to_s) %>
                              <% end %>
                            <% end %>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>

                  <% else %>
                    <%= simple_format(value.to_s) %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
</div>
