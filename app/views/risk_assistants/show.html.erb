<%#--------------------------------------------------------------%>
<%#                 CONTENIDO                                    %>
<%#--------------------------------------------------------------%>
<div class="container-xxl py-3">

  <!-- ───── CABECERA ────────────────────────────────────────── -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0"><%= @risk_assistant.name %></h1>

    <!-- botón hamburguesa visible < md -->
    <button class="btn btn-outline-secondary d-md-none"
            data-bs-toggle="offcanvas"
            data-bs-target="#sidebarCanvas">
      <i class="bi bi-list"></i>
    </button>
  </div>

  <div class="row gx-lg-5">
    <!-- ■■■  SIDEBAR  ■■■ -->
    <aside class="col-lg-4 col-md-5">

      <!-- escritorio -->
      <div class="d-none d-md-block">
        <div class="sidebar-box">
          <%= render partial:"sidebar",
                     locals:{ sections:@sections,
                              progress_by_section:@progress_by_section,
                              overall_pct:@overall_pct,
                              risk_assistant:@risk_assistant } %>
        </div>
      </div>

      <!-- off-canvas móvil -->
      <div class="offcanvas offcanvas-start d-md-none" id="sidebarCanvas">
        <div class="offcanvas-header border-bottom">
          <h5 class="offcanvas-title">Panel</h5>
          <button class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
          <div class="sidebar-box border-0 rounded-0">
            <%= render partial:"sidebar",
                       locals:{ sections:@sections,
                                progress_by_section:@progress_by_section,
                                overall_pct:@overall_pct,
                                risk_assistant:@risk_assistant } %>
          </div>
        </div>
      </div>
    </aside>

    <!-- ■■■  MAIN / CHAT  ■■■ -->
    <main class="col-lg-8 col-md-7">
      <div class="chat-page">

        <!---- chat-history ---->
        <div class="chat-history">
          <%#  ⬇️  orden correcto: ASC  ⬇️  %>
          <% @risk_assistant.messages.order(created_at: :asc).each do |m| %>
            <% css_row = m.sender == 'user' ? 'user' : 'assistant' %>
            <% css_box = m.sender == 'user' ? 'user' : '' %>

            <div class="message-row <%= css_row %>">
              <div class="message-box <%= css_box %>">
                <div class="header">
                  <strong><%= m.sender.capitalize %></strong>
                  <small><%= l m.created_at, format: :short %></small>
                </div>

                <div class="body"><%= simple_format m.content %></div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- FORMULARIO -->
        <%= form_with url:risk_assistant_messages_path(@risk_assistant),
                      method: :post, local:true, multipart:true,
                      html:{class:'chat-form border-top'} do |f| %>
          <div class="input-group">
            <%= f.text_area :content, name:'message[content]',
                  rows:1, required:true,
                  class:'form-control', placeholder:'Escribe tu mensaje…' %>

            <%= file_field_tag :file, id:'fileUpload', class: 'd-none' %>

          <button type="button"
                  class="btn-attach"
                  onclick="document.getElementById('fileUpload').click()">
            <i class="bi bi-paperclip"></i>
          </button>

            <%= f.submit 'Enviar', class:'btn-send' %>
          </div>
        <% end %>

      </div>
    </main>
  </div>
</div>

<script>
  // Auto-scroll al último mensaje
  function scrollChatBottom(){
    const hist = document.querySelector('.chat-history');
    if(hist){ hist.scrollTop = hist.scrollHeight; }
  }
  document.addEventListener('DOMContentLoaded', scrollChatBottom);
  document.addEventListener('turbo:frame-load', scrollChatBottom);
  document.addEventListener('turbo:render', scrollChatBottom);
</script>

<!-- 
      <%# -------- BOTONERA RÁPIDA DE SECCIONES ------------------ %>
      <div class="row g-2 mb-3">
        <% @sections.each_with_index do |sec,i| %>
          <div class="col-6 col-sm-4 col-lg-3">
            <button class="btn btn-outline-primary w-100"
                    data-bs-toggle="collapse"
                    data-bs-target="#form<%= i %>">
              <strong><%= i+1 %>.</strong>
              <%= truncate(sec, length:22) %>
            </button>
          </div>
        <% end %>
      </div>

      <%# -------- COLLAPSABLES DE FORMULARIOS ------------------- %>
      <div id="formsGroup">
        <% @sections.each_with_index do |sec,i| %>
          <div class="collapse mb-3" id="form<%= i %>"
               data-bs-parent="#formsGroup">
            <div class="card p-3 shadow-sm">
              <h5 class="mb-2"><%= i+1 %>. <%= sec %></h5>
              <%= form_with url: risk_assistant_messages_path(@risk_assistant),
                            method: :post, local: true,
                            multipart: true do |f| %>
                <%= f.hidden_field :section,
                                   name:"message[section]",
                                   value:sec.parameterize(separator:"_") %>

                <div class="mb-2">
                  <%= f.label :content, "Mensaje" %>
                  <%= f.text_area :content,
                                  name:"message[content]",
                                  rows:3, required:true,
                                  class:"form-control" %>
                </div>
                <%= file_field_tag :file, class:"form-control mb-2" %>
                <%= f.submit "Enviar", class:"btn btn-pri" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
-->