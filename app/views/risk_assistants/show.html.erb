<!-- app/views/risk_assistants/show.html.erb -->
<%# -------------------------------------------------------------- %>
<%#  Hoja de estilo ligera in-page (podr√≠as llevarla a assets)    %>
<%# -------------------------------------------------------------- %>
<style>
  :root{
    --pri:#1f497d;        /* color principal */
    --pri-light:#275ba0;  /* hover / foco   */
    --gray-bg:#f4f6f8;    /* gris de fondo  */
    --radius: .6rem;
  }
  body{background:var(--gray-bg);}
  h2,h3,h4{color:var(--pri);}
  .btn-pri     {color:#fff;background:var(--pri);border-color:var(--pri);}
  .btn-pri:hover{background:var(--pri-light);border-color:var(--pri-light);}
  .sidebar-header{font-weight:600;}
  .table-sm td,.table-sm th{padding:.4rem .6rem;}
  /* Oculta scroll vertical ‚Äúinfinito‚Äù en tablas */
  .scroll-y    {max-height:46vh;overflow-y:auto;}
</style>

<%# -------------------------------------------------------------- %>
<%#           CONTENEDOR PRINCIPAL                                %>
<%# -------------------------------------------------------------- %>
<div class="container-xxl py-3" style="background-color:white;">

  <%# ---------- BREADCRUMB / TITULAR --------------------------- %>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0"><%= @risk_assistant.name %></h1>

    <%#  btn que abre off-canvas s√≥lo < md  %>
    <button
      class="btn btn-outline-secondary d-md-none"
      type="button"
      data-bs-toggle="offcanvas"
      data-bs-target="#sidebarCanvas">
      Men√∫
    </button>
  </div>

  <%# ------------------------------------------------------------ %>
  <%#     LAYOUT:  SIDEBAR  +  MAIN                               %>
  <%# ------------------------------------------------------------ %>
  <div class="row gx-lg-5">

    <%# ============  SIDEBAR  =================================== %>
    <aside class="col-lg-4 col-md-5">

      <%# ‚Äî versi√≥n fija escritorio ‚Äî %>
      <div class="d-none d-md-block">
        <%= render partial: "sidebar",
                   locals: { sections: @sections,
                             progress_by_section: @progress_by_section,
                             overall_pct: @overall_pct,
                             risk_assistant: @risk_assistant } %>
      </div>

      <%# ‚Äî off-canvas para m√≥vil / tablet ‚Äî %>
      <div class="offcanvas offcanvas-start d-md-none"
           tabindex="-1" id="sidebarCanvas">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title">Men√∫</h5>
          <button type="button" class="btn-close"
                  data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
          <%= render partial: "sidebar",
                     locals: { sections: @sections,
                               progress_by_section: @progress_by_section,
                               overall_pct: @overall_pct,
                               risk_assistant: @risk_assistant } %>
        </div>
      </div>
    </aside>

    <%# ============  MAIN  ====================================== %>
    <main class="col-lg-8 col-md-7">
      <div class="container-fluid chat-page">

        <!-- HIST√ìRICO --------------------------------------------------- -->
        <div class="chat-history px-3 py-2">
          <% @risk_assistant.messages.order(:created_at).each do |m| %>
            <% my_msg  = m.sender == 'user' %>
            <% bubble  = my_msg ? 'chat-bubble-user' : 'chat-bubble-assistant' %>
            <% wrap    = my_msg ? 'justify-content-end' : 'justify-content-start' %>

            <div class="d-flex <%= wrap %> mb-2">
              <div class="<%= bubble %>">
                <div class="chat-header">
                  <strong><%= m.sender.capitalize %></strong>
                  <small class="ms-2 text-muted"><%= l m.created_at, format: :short %></small>
                </div>
                <div class="chat-body"><%= simple_format m.content %></div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- FORMULARIO FIJO --------------------------------------------- -->
        <%= form_with url: risk_assistant_messages_path(@risk_assistant),
                      method: :post, local: true, multipart: true,
                      html: { class: 'chat-form p-2' } do |f| %>

          <div class="input-group">
            <%= f.text_area :content,
                  name:'message[content]',
                  rows:1,
                  required:true,
                  class:'form-control',
                  placeholder:'Escribe tu mensaje‚Ä¶' %>

            <%= file_field_tag :file,
                  class:'form-control-file d-none', id:'fileUpload' %>

            <button class="btn btn-outline-secondary" type="button"
                    onclick="document.getElementById('fileUpload').click()">
              üìé
            </button>

            <%= f.submit 'Enviar', class:'btn btn-primary' %>
          </div>
        <% end %>
      </div>
    </main>
  </div>
</div>

<!-- *** Pega esto justo debajo del <style> o al final de la vista *** -->
<script>
  function scrollChatBottom() {
    const box = document.querySelector('.chat-history');
    if (box) { box.scrollTop = box.scrollHeight; }
  }

  // ‚Äî‚ÄäAl cargar la vista inicial
  document.addEventListener('DOMContentLoaded', scrollChatBottom);

  // ‚Äî‚ÄäCada vez que Turbo actualice la conversaci√≥n (por ej. al enviar un mensaje)
  document.addEventListener('turbo:frame-load', scrollChatBottom);
  document.addEventListener('turbo:render',      scrollChatBottom);
</script>



<!-- 
      <%# -------- BOTONERA R√ÅPIDA DE SECCIONES ------------------ %>
      <div class="row g-2 mb-3">
        <% @sections.each_with_index do |sec,i| %>
          <div class="col-6 col-sm-4 col-lg-3">
            <button class="btn btn-outline-primary w-100"
                    data-bs-toggle="collapse"
                    data-bs-target="#form<%= i %>">
              <strong><%= i+1 %>.</strong>
              <%= truncate(sec, length:22) %>
            </button>
          </div>
        <% end %>
      </div>

      <%# -------- COLLAPSABLES DE FORMULARIOS ------------------- %>
      <div id="formsGroup">
        <% @sections.each_with_index do |sec,i| %>
          <div class="collapse mb-3" id="form<%= i %>"
               data-bs-parent="#formsGroup">
            <div class="card p-3 shadow-sm">
              <h5 class="mb-2"><%= i+1 %>. <%= sec %></h5>
              <%= form_with url: risk_assistant_messages_path(@risk_assistant),
                            method: :post, local: true,
                            multipart: true do |f| %>
                <%= f.hidden_field :section,
                                   name:"message[section]",
                                   value:sec.parameterize(separator:"_") %>

                <div class="mb-2">
                  <%= f.label :content, "Mensaje" %>
                  <%= f.text_area :content,
                                  name:"message[content]",
                                  rows:3, required:true,
                                  class:"form-control" %>
                </div>
                <%= file_field_tag :file, class:"form-control mb-2" %>
                <%= f.submit "Enviar", class:"btn btn-pri" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
-->